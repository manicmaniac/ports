name: Test
on: push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test:
    runs-on: macOS-12
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v3
    - uses: melusina-org/gha-install-macports@v1
    - name: Update MacPorts
      run: sudo port selfupdate
    - name: Install known dependencies
      run: sudo port install go pandoc
    - name: Check PortIndex
      run: |
        portindex
        git diff --exit-code HEAD -- PortIndex PortIndex.quick
    - name: Lint
      run: cut -d ' ' -f 1 PortIndex.quick | xargs port lint --nitpick
    - name: Install
      id: install
      run: cut -d ' ' -f 1 PortIndex.quick | sudo xargs port install 2>&1 | tee "$TMPDIR/install.log"
    - name: Show failure log
      if: failure() && steps.install.outcome == 'failure'
      run: grep 'Error:' "$TMPDIR/install.log" | grep -o ' /[^ ]*[.]log ' | xargs cat
